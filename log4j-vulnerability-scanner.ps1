$date = Get-Date -Format "yyyy-MM-dd_HHmm"
$ErrorActionPreference= 'silentlycontinue'
$outdir = "log4j-scan-result"
$out = -join($outdir, "\",$env:COMPUTERNAME,"_",$env:USERNAME,"_ScanForLog4j_",$date)
mkdir $outdir 

handle | Select-String "log4j" | out-file  -Encoding ASCII "$out.allFiles.log"

foreach ($drive in gdr -PSProvider 'FileSystem' |  select -exp Root)
{
    dir -Recurse $drive |Select-Object -ExpandProperty FullName | Select-String -Pattern "log4j" | out-file -Append -Encoding ASCII "$out.allFiles.log"
}

Get-WmiObject Win32_Process | Select-Object CommandLine | Select-String "log4j" | out-file -Encoding ASCII "$out.processes.log"

foreach ($drive in gdr -PSProvider 'FileSystem' |  select -exp Root)
{
    gci $drive -rec -force -Include "*.jar","*.war","*.ear","*.zip" | foreach {select-string "JndiLookup.class" $_} | select -exp Path | out-file -Append -Encoding ASCII "$out.vulnerable_jndiclass.log"
}
